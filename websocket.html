<!DOCTYPE html>
<html>

<head>
    <title>Consola ESP32</title>
    <link rel="shortcut icon" href="https://cdn.icon-icons.com/icons2/350/PNG/512/bash_36261.png">
</head>

<body>
    <style>
        #send {
          width: 114px;
        }
      </style>

    <h2 style="text-align: center">Consola Esp32</h2> 
    <div id="mi-contenedor" style="display: flex; margin-bottom: 20px;">
        <textarea id='console' rows='10' cols='50' style="flex: 1;"></textarea> 
    </div>
    <div id="mi-contenedor" style="display: flex;">
        <input id='command' style="flex: 1"></input> 
        <button id='send' style="width: auto" onclick='sendCommand()'>Enviar mensaje</button>
    </div>
    
    <script>     
        
        const PING_INTERVAL = 1000;

        class Cmd {
            constructor() {
                this.connect();
            }

            connect() {
                this.write('Conectando...');
                this.socket !== undefined && this.socket.close();
                this.socket = new WebSocket('ws://192.168.0.14:8080'); 
                this.socket.onmessage = (e) => { this.write(e.data); }; 
                this.socket.onclose = (e) => { this.connect(); };
                setInterval(() => { this.ping() }, PING_INTERVAL);
            }

            send(msg) { 
                if (this.socket.readyState === 1)
                    this.socket.send(msg);
                else if (this.socket.readyState !== 0)
                    this.connect();
            }

            write(mensaje) { 
                let cmd = document.getElementById('console'); 
                cmd.textContent += mensaje.toString() + '\n';
                cmd.scrollTop = cmd.scrollHeight;
            }

            ping() {
                this.send("");
            }
        }

        let cmd = new Cmd();

        // Para enviar mensaje cuando se presiona enter
        const input = document.getElementById("command");
        input.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                sendCommand();
            }
        });

        // Para calcular el ancho del input usando js
        const boton = document.getElementById("send");
        const anchoBoton = getComputedStyle(boton).width;
        document.documentElement.style.setProperty("--ancho-boton", anchoBoton);
        
        function sendCommand() {
            cmd.send(document.getElementById('command').value); 
            document.getElementById('command').value = "";
        }
        
    </script>
</body>

</html>